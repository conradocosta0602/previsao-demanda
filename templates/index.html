<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Previsao de Demanda</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/multi-select.js') }}"></script>
</head>
<body>
    <div class="container">
        <!-- Header Compacto -->
        <div class="header-compact" style="display: flex; justify-content: space-between; align-items: center;">
            <div class="logo-section">
                <h1>Previsao de Demanda</h1>
                <p>Multi-Loja + CD</p>
            </div>
            <a href="/menu" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; font-size: 0.9em;">
                üè† Menu Principal
            </a>
        </div>

        <!-- Grid Layout Principal -->
        <div class="main-grid">
            <!-- Coluna Esquerda: Upload e Configura√ß√µes -->
            <div class="sidebar-left">
                <div class="upload-section-compact card-compact">
                    <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">
                        <h3 style="margin: 0; color: #667eea; font-size: 1em;">üíæ Consulta do Banco de Dados</h3>
                    </div>

                    <!-- FORMUL√ÅRIO BANCO DE DADOS -->
                    <form id="bancoForm" style="display: block;">
                        <div class="config-compact">
                            <label>Loja:</label>
                            <div class="multi-select-container" data-id="loja_banco"></div>
                        </div>

                        <div class="config-compact">
                            <label>Fornecedor:</label>
                            <div class="multi-select-container" data-id="fornecedor_banco"></div>
                        </div>

                        <div class="config-compact">
                            <label>Linha 1:</label>
                            <div class="multi-select-container" data-id="linha_banco"></div>
                        </div>

                        <div class="config-compact">
                            <label>Linha 3:</label>
                            <div class="multi-select-container" data-id="sublinha_banco"></div>
                        </div>

                        <div class="config-compact">
                            <label>Produto:</label>
                            <div class="multi-select-container" data-id="produto_banco"></div>
                        </div>

                        <div class="config-compact">
                            <label for="granularidade_banco">Granularidade:</label>
                            <select id="granularidade_banco" name="granularidade">
                                <option value="diario">Di√°rio (at√© 3 meses)</option>
                                <option value="semanal">Semanal (at√© 6 meses)</option>
                                <option value="mensal" selected>Mensal (at√© 24 meses)</option>
                            </select>
                        </div>

                        <!-- Per√≠odo de Previs√£o Din√¢mico -->
                        <div id="periodo_previsao_container">
                            <!-- Mensal: M√™s/Ano in√≠cio e fim -->
                            <div id="periodo_mensal" class="periodo-config">
                                <label>Per√≠odo de Previs√£o:</label>
                                <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
                                    <select id="mes_inicio" style="flex: 1; padding: 6px;">
                                        <option value="1">Jan</option>
                                        <option value="2">Fev</option>
                                        <option value="3">Mar</option>
                                        <option value="4">Abr</option>
                                        <option value="5">Mai</option>
                                        <option value="6">Jun</option>
                                        <option value="7">Jul</option>
                                        <option value="8">Ago</option>
                                        <option value="9">Set</option>
                                        <option value="10">Out</option>
                                        <option value="11">Nov</option>
                                        <option value="12">Dez</option>
                                    </select>
                                    <select id="ano_inicio" style="width: 80px; padding: 6px;"></select>
                                </div>
                                <div style="text-align: center; color: #666; font-size: 0.8em; margin: 3px 0;">at√©</div>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <select id="mes_fim" style="flex: 1; padding: 6px;">
                                        <option value="1">Jan</option>
                                        <option value="2">Fev</option>
                                        <option value="3">Mar</option>
                                        <option value="4">Abr</option>
                                        <option value="5">Mai</option>
                                        <option value="6">Jun</option>
                                        <option value="7">Jul</option>
                                        <option value="8">Ago</option>
                                        <option value="9">Set</option>
                                        <option value="10">Out</option>
                                        <option value="11">Nov</option>
                                        <option value="12">Dez</option>
                                    </select>
                                    <select id="ano_fim" style="width: 80px; padding: 6px;"></select>
                                </div>
                            </div>

                            <!-- Semanal: Semana/Ano in√≠cio e fim -->
                            <div id="periodo_semanal" class="periodo-config" style="display: none;">
                                <label>Per√≠odo de Previs√£o:</label>
                                <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
                                    <span style="font-size: 0.85em;">Sem.</span>
                                    <input type="number" id="semana_inicio" min="1" max="53" value="1" style="width: 50px; padding: 6px;">
                                    <span style="font-size: 0.85em;">de</span>
                                    <select id="ano_semana_inicio" style="width: 80px; padding: 6px;"></select>
                                </div>
                                <div style="text-align: center; color: #666; font-size: 0.8em; margin: 3px 0;">at√©</div>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <span style="font-size: 0.85em;">Sem.</span>
                                    <input type="number" id="semana_fim" min="1" max="53" value="12" style="width: 50px; padding: 6px;">
                                    <span style="font-size: 0.85em;">de</span>
                                    <select id="ano_semana_fim" style="width: 80px; padding: 6px;"></select>
                                </div>
                            </div>

                            <!-- Di√°rio: Data in√≠cio e fim -->
                            <div id="periodo_diario" class="periodo-config" style="display: none;">
                                <label>Per√≠odo de Previs√£o:</label>
                                <div style="margin-top: 5px;">
                                    <input type="date" id="data_inicio" style="width: 100%; padding: 6px; margin-bottom: 5px;">
                                </div>
                                <div style="text-align: center; color: #666; font-size: 0.8em; margin: 3px 0;">at√©</div>
                                <div>
                                    <input type="date" id="data_fim" style="width: 100%; padding: 6px;">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary-compact">
                            Gerar Previs√£o
                        </button>
                    </form>

                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <a href="/simulador" class="btn-secondary-compact" style="display: block; text-align: center; text-decoration: none; padding: 8px;">
                            üéØ Simulador de Cen√°rios ‚Üí
                        </a>
                    </div>
                </div>
            </div>

            <!-- Coluna Central e Direita: Conte√∫do Principal -->
            <div class="main-content">

                <div id="progress" class="progress-section-compact card-compact" style="display:none;">
                    <div class="progress-bar-compact">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText" class="progress-text-compact">Processando...</p>
                </div>

                <div id="results" class="results-section-compact" style="display:none;">
                    <!-- KPIs no Topo -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                        <!-- Card WMAPE -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white; text-align: center;">
                            <div style="font-size: 0.85em; font-weight: 500; opacity: 0.9; margin-bottom: 8px;">WMAPE</div>
                            <div id="kpi_wmape" style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">-</div>
                            <div style="font-size: 0.75em; opacity: 0.8;">Acur√°cia da Previs√£o</div>
                        </div>

                        <!-- Card BIAS -->
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white; text-align: center;">
                            <div style="font-size: 0.85em; font-weight: 500; opacity: 0.9; margin-bottom: 8px;">BIAS</div>
                            <div id="kpi_bias" style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">-</div>
                            <div style="font-size: 0.75em; opacity: 0.8;">Vi√©s da Previs√£o</div>
                        </div>

                        <!-- Card Varia√ß√£o Demanda -->
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white; text-align: center;">
                            <div style="font-size: 0.85em; font-weight: 500; opacity: 0.9; margin-bottom: 8px;">VARIA√á√ÉO DEMANDA</div>
                            <div id="kpi_variacao" style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">-</div>
                            <div style="font-size: 0.75em; opacity: 0.8;">Per√≠odo Previsto vs Ano Anterior</div>
                        </div>
                    </div>

                    <!-- Gr√°fico Principal -->
                    <div class="card-compact" style="margin-bottom: 20px;">
                        <h3 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; margin: -15px -15px 15px -15px;">
                            üìà Hist√≥rico e Previs√£o de Demanda
                        </h3>
                        <div class="chart-container-compact" style="height: 400px;">
                            <canvas id="previsaoChart"></canvas>
                        </div>
                    </div>

                    <!-- Tabela Comparativa - Meses nas Colunas -->
                    <div class="card-compact">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #667eea; margin: 0;">üìã Tabela Comparativa</h3>
                            <button id="btnExportarTabelaComparativa" onclick="exportarTabelaComparativa()"
                                    style="padding: 6px 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                           color: white; border: none; border-radius: 5px; cursor: pointer;
                                           font-size: 0.85em; display: flex; align-items: center; gap: 5px;
                                           transition: transform 0.2s, box-shadow 0.2s;"
                                    onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(16,185,129,0.3)';"
                                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                <span>üì•</span> Exportar Excel
                            </button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="tabelaComparativa" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead id="tabelaComparativaHeader">
                                    <!-- Preenchido dinamicamente com os meses -->
                                </thead>
                                <tbody id="tabelaComparativaBody">
                                    <!-- Preenchido dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tabela Fornecedor/Item -->
                    <div class="card-compact">
                        <h3>üìä Previs√£o por Fornecedor/Item</h3>

                        <!-- Legenda dos Alertas -->
                        <div style="margin-bottom: 15px; padding: 12px; background-color: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                            <div style="font-weight: bold; color: #495057; margin-bottom: 8px; font-size: 0.9em;">
                                üîç Legenda dos Indicadores
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.85em;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3em;">üî¥</span>
                                    <div>
                                        <strong style="color: #dc2626;">Cr√≠tico</strong>
                                        <div style="color: #666; font-size: 0.9em;">Requer a√ß√£o imediata</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3em;">üü°</span>
                                    <div>
                                        <strong style="color: #f59e0b;">Alerta</strong>
                                        <div style="color: #666; font-size: 0.9em;">Varia√ß√£o &gt; 50%</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3em;">üîµ</span>
                                    <div>
                                        <strong style="color: #3b82f6;">Aten√ß√£o</strong>
                                        <div style="color: #666; font-size: 0.9em;">Varia√ß√£o &gt; 20%</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3em;">üü¢</span>
                                    <div>
                                        <strong style="color: #10b981;">Normal</strong>
                                        <div style="color: #666; font-size: 0.9em;">Varia√ß√£o ‚â§ 20%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="overflow-x: auto;">
                            <table id="fornecedorItemTable" style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
                                <tbody id="fornecedorItemBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Relat√≥rio Detalhado por Fornecedor/Item -->
                    <div id="relatorioDetalhadoSection" class="card-compact" style="display: none; margin-top: 20px;">
                        <h3 style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px; border-radius: 8px; margin: -15px -15px 15px -15px;">
                            üìä Relat√≥rio Detalhado por Fornecedor/Item
                        </h3>

                        <!-- Filtros do Relat√≥rio -->
                        <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; color: #495057; font-size: 0.9em;">Fornecedor:</label>
                                <select id="filtroFornecedorRelatorio" style="padding: 6px 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.85em;">
                                    <option value="">Todos os Fornecedores</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; color: #495057; font-size: 0.9em;">Alerta:</label>
                                <select id="filtroAlertaRelatorio" style="padding: 6px 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.85em;">
                                    <option value="">Todos</option>
                                    <option value="vermelho">üî¥ Cr√≠tico</option>
                                    <option value="amarelo">üü° Alerta</option>
                                    <option value="azul">üîµ Aten√ß√£o</option>
                                    <option value="verde">üü¢ Normal</option>
                                    <option value="cinza">‚ö™ Sem Previs√£o</option>
                                </select>
                            </div>
                            <button onclick="filtrarRelatorioDetalhado()" style="padding: 6px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                                üîç Filtrar
                            </button>
                            <button onclick="expandirTodosFornecedores()" style="padding: 6px 15px; background: #f8f9fa; color: #495057; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                                ‚ûï Expandir Todos
                            </button>
                            <button onclick="recolherTodosFornecedores()" style="padding: 6px 15px; background: #f8f9fa; color: #495057; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                                ‚ûñ Recolher Todos
                            </button>
                        </div>

                        <!-- Tabela do Relat√≥rio Detalhado -->
                        <div style="overflow-x: auto; max-height: 600px; overflow-y: auto; width: 100%;">
                            <table id="relatorioDetalhadoTable" style="width: max-content; min-width: 100%; border-collapse: collapse; font-size: 0.8em;">
                                <thead id="relatorioDetalhadoHeader" style="position: sticky; top: 0; background: white; z-index: 10;">
                                    <!-- Preenchido dinamicamente -->
                                </thead>
                                <tbody id="relatorioDetalhadoBody">
                                    <!-- Preenchido dinamicamente -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Resumo do Relat√≥rio -->
                        <div id="resumoRelatorioDetalhado" style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; display: none;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                                <div>
                                    <div style="font-size: 0.75em; color: #666;">Total Fornecedores</div>
                                    <div id="resumoTotalFornecedores" style="font-size: 1.4em; font-weight: bold; color: #495057;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666;">Total Itens</div>
                                    <div id="resumoTotalItens" style="font-size: 1.4em; font-weight: bold; color: #495057;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666;">üî¥ Cr√≠ticos</div>
                                    <div id="resumoCriticos" style="font-size: 1.4em; font-weight: bold; color: #dc2626;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666;">üü° Alertas</div>
                                    <div id="resumoAlertas" style="font-size: 1.4em; font-weight: bold; color: #f59e0b;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666;">üîµ Aten√ß√£o</div>
                                    <div id="resumoAtencao" style="font-size: 1.4em; font-weight: bold; color: #3b82f6;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666;">üü¢ Normais</div>
                                    <div id="resumoNormais" style="font-size: 1.4em; font-weight: bold; color: #10b981;">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="download-section-compact" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button id="downloadBtn" class="btn-download-compact" onclick="exportarRelatorioItens()" disabled
                            title="Gere uma previs√£o para habilitar o download"
                            style="opacity: 0.5; cursor: not-allowed;">
                            Download Excel
                        </button>
                    </div>
                </div>

                <div id="error" class="error-section-compact card-compact" style="display:none;">
                    <h3>Erro</h3>
                    <p id="errorMessage"></p>
                    <button onclick="location.reload()" class="btn-secondary-compact">Tentar Novamente</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
