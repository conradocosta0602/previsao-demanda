<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compra Planejada - Forward Buying</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #333; }

        .page-container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .page-header h1 { font-size: 1.5em; color: #1a1a2e; }
        .page-header .subtitle { color: #6b7280; font-size: 0.85em; margin-top: 4px; }
        .page-header a {
            padding: 8px 16px; background: #667eea; color: white;
            text-decoration: none; border-radius: 8px; font-size: 0.85em;
        }

        .main-layout { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }

        /* Sidebar */
        .sidebar {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); position: sticky; top: 20px;
            align-self: start; max-height: calc(100vh - 40px); overflow-y: auto;
        }
        .sidebar h3 { font-size: 1em; color: #1a1a2e; margin-bottom: 16px; }

        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 0.8em; font-weight: 600; color: #374151; margin-bottom: 4px; }
        .form-group select, .form-group input {
            width: 100%; padding: 8px 10px; border: 1px solid #d1d5db;
            border-radius: 8px; font-size: 0.85em; background: white;
        }

        .multi-select-container {
            border: 1px solid #d1d5db; border-radius: 8px; padding: 6px;
            max-height: 120px; overflow-y: auto; background: white;
        }
        .multi-select-container label {
            display: flex; align-items: center; gap: 6px;
            padding: 3px 4px; font-size: 0.8em; cursor: pointer; font-weight: normal;
        }
        .multi-select-container label:hover { background: #f3f4f6; border-radius: 4px; }
        .multi-select-container input[type="checkbox"] { width: auto; }

        .multi-select-actions {
            display: flex; gap: 6px; margin-bottom: 6px;
        }
        .multi-select-actions button {
            flex: 1; padding: 4px 8px; font-size: 0.72em; border: 1px solid #d1d5db;
            border-radius: 4px; background: #f9fafb; color: #374151; cursor: pointer;
        }
        .multi-select-actions button:hover { background: #e5e7eb; }

        /* Datas de entrega */
        .datas-container { margin-bottom: 14px; }
        .datas-container .header-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .datas-container .header-row label { margin-bottom: 0; }
        .btn-add-data {
            padding: 4px 10px; background: #10b981; color: white; border: none;
            border-radius: 6px; font-size: 0.75em; cursor: pointer;
        }
        .btn-add-data:hover { background: #059669; }
        .data-entry {
            display: flex; align-items: center; gap: 6px; margin-bottom: 6px;
        }
        .data-entry input { flex: 1; }
        .data-entry .fase-label {
            font-size: 0.7em; font-weight: 600; color: white;
            padding: 2px 8px; border-radius: 10px; white-space: nowrap;
        }
        .fase-label.completo { background: #059669; }
        .fase-label.bruta { background: #d97706; }
        .btn-remove-data {
            padding: 4px 8px; background: #ef4444; color: white; border: none;
            border-radius: 6px; font-size: 0.75em; cursor: pointer;
        }

        .btn-calcular {
            width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; border-radius: 8px; font-size: 0.95em;
            font-weight: 600; cursor: pointer; margin-top: 8px;
        }
        .btn-calcular:hover { opacity: 0.9; }
        .btn-calcular:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Content area */
        .content { display: flex; flex-direction: column; gap: 16px; }

        .card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;
        }
        .card-header h3 { font-size: 1.05em; color: #1a1a2e; }

        /* Instrucoes */
        .instrucoes { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .instrucoes .icon { font-size: 3em; margin-bottom: 16px; }
        .instrucoes h3 { color: #6b7280; margin-bottom: 8px; }
        .instrucoes p { font-size: 0.9em; max-width: 500px; margin: 0 auto; line-height: 1.6; }

        /* Progress */
        .progress-container { padding: 20px 0; }
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px; transition: width 0.3s;
        }
        .progress-text { text-align: center; margin-top: 8px; font-size: 0.85em; color: #6b7280; }

        /* Erro */
        .error-card {
            background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px;
            padding: 16px 20px; display: none;
        }
        .error-card .error-title { color: #dc2626; font-weight: 600; margin-bottom: 4px; }
        .error-card .error-msg { color: #7f1d1d; font-size: 0.9em; }

        /* Resumo geral */
        .resumo-geral {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 12px; padding: 20px; color: white;
        }
        .resumo-geral .titulo { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        .resumo-geral .fornecedor { font-size: 1.1em; font-weight: 600; margin: 4px 0 16px; }
        .resumo-metricas { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .metrica { text-align: center; }
        .metrica .valor { font-size: 1.3em; font-weight: 700; }
        .metrica .label { font-size: 0.7em; opacity: 0.7; margin-top: 2px; }

        /* Fases cards */
        .fase-card {
            background: white; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden;
        }
        .fase-header {
            padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;
        }
        .fase-header.completo { background: linear-gradient(135deg, #059669, #10b981); color: white; }
        .fase-header.bruta { background: linear-gradient(135deg, #d97706, #f59e0b); color: white; }
        .fase-header .fase-titulo { font-weight: 600; }
        .fase-header .fase-info { font-size: 0.8em; opacity: 0.9; }
        .fase-header .fase-valor { font-size: 1.2em; font-weight: 700; }

        .fase-body { padding: 16px 20px; }

        /* Tabelas */
        .tabela-container { overflow-x: auto; max-height: 400px; overflow-y: auto; }
        .tabela-itens {
            width: 100%; border-collapse: collapse; font-size: 0.8em;
        }
        .tabela-itens thead { position: sticky; top: 0; z-index: 1; }
        .tabela-itens th {
            padding: 8px 10px; text-align: center; font-weight: 600;
            color: white; font-size: 0.85em;
        }
        .tabela-itens th.completo { background: #059669; }
        .tabela-itens th.bruta { background: #d97706; }
        .tabela-itens td { padding: 6px 10px; border-bottom: 1px solid #f3f4f6; }
        .tabela-itens .col-num { text-align: right; }
        .tabela-itens .col-desc { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .tabela-itens tbody tr:hover { background: #f9fafb; }

        /* Botoes de acao */
        .btn-sm {
            padding: 6px 14px; border: none; border-radius: 6px;
            font-size: 0.8em; cursor: pointer; font-weight: 500;
        }
        .btn-exportar { background: #667eea; color: white; }
        .btn-exportar:hover { background: #5a6fd6; }
        .btn-toggle { background: #f3f4f6; color: #374151; }
        .btn-toggle:hover { background: #e5e7eb; }

        /* Responsivo */
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { position: static; }
            .resumo-metricas { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <div class="page-header">
            <div>
                <h1>Compra Planejada</h1>
                <div class="subtitle">Forward Buying - Calcule compras futuras para negociacao com fornecedores</div>
            </div>
            <a href="/menu">Menu Principal</a>
        </div>

        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <h3>Parametros</h3>

                <!-- Destino -->
                <div class="form-group">
                    <label>Destino</label>
                    <select id="destinoTipo">
                        <option value="LOJA">Lojas (Direto)</option>
                        <option value="CD">CD (Centralizado)</option>
                    </select>
                </div>

                <!-- Lojas -->
                <div class="form-group">
                    <label>Lojas</label>
                    <div class="multi-select-actions">
                        <button onclick="marcarTodos('lojasContainer')">Marcar Todos</button>
                        <button onclick="desmarcarTodos('lojasContainer')">Desmarcar Todos</button>
                    </div>
                    <div class="multi-select-container" id="lojasContainer">
                        <!-- Populado via JS -->
                    </div>
                </div>

                <!-- Fornecedor -->
                <div class="form-group">
                    <label>Fornecedor</label>
                    <div class="multi-select-actions">
                        <button onclick="marcarTodos('fornecedorContainer')">Marcar Todos</button>
                        <button onclick="desmarcarTodos('fornecedorContainer')">Desmarcar Todos</button>
                    </div>
                    <div class="multi-select-container" id="fornecedorContainer" style="max-height: 150px;">
                        <!-- Populado via JS -->
                    </div>
                </div>

                <!-- Linha 1 -->
                <div class="form-group">
                    <label>Linha 1 (Categoria)</label>
                    <select id="linha1">
                        <option value="TODAS">Todas</option>
                    </select>
                </div>

                <!-- Linha 3 -->
                <div class="form-group">
                    <label>Linha 3 (Subcategoria)</label>
                    <select id="linha3">
                        <option value="TODAS">Todas</option>
                    </select>
                </div>

                <!-- Cobertura -->
                <div class="form-group">
                    <label>Cobertura (Pedido 1)</label>
                    <select id="coberturaDias">
                        <option value="">Automatica (ABC)</option>
                        <option value="30">30 dias</option>
                        <option value="45">45 dias</option>
                        <option value="60">60 dias</option>
                        <option value="75">75 dias</option>
                        <option value="90">90 dias</option>
                        <option value="120">120 dias</option>
                    </select>
                    <small style="color:#6b7280;font-size:0.72em;margin-top:2px;display:block;">
                        Pedido 1 = reabastecimento. Demais = repor estoque para manter cobertura-alvo.
                    </small>
                </div>

                <!-- Datas de entrega -->
                <div class="datas-container">
                    <div class="header-row">
                        <label style="font-size: 0.8em; font-weight: 600; color: #374151;">Datas de Entrega</label>
                        <button class="btn-add-data" onclick="adicionarDataEntrega()">+ Data</button>
                    </div>
                    <div id="datasEntregaContainer">
                        <!-- Datas adicionadas aqui -->
                    </div>
                </div>

                <button class="btn-calcular" id="btnCalcular" onclick="calcularCompraPlanejada()">
                    Calcular Compra Planejada
                </button>

            </div>

            <!-- Content -->
            <div class="content">
                <!-- Instrucoes iniciais -->
                <div class="card" id="instrucoes">
                    <div class="instrucoes">
                        <div class="icon">ðŸ“¦</div>
                        <h3>Compra Planejada (Forward Buying)</h3>
                        <p>
                            Selecione o fornecedor, adicione as datas de entrega desejadas e calcule
                            as quantidades para negociacao. Exporte o resultado em Excel para apresentar
                            ao fornecedor.
                        </p>
                    </div>
                </div>

                <!-- Progresso -->
                <div class="card" id="progressCard" style="display: none;">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">Calculando...</div>
                    </div>
                </div>

                <!-- Erro -->
                <div class="error-card" id="errorCard">
                    <div class="error-title">Erro</div>
                    <div class="error-msg" id="errorMessage"></div>
                </div>

                <!-- Resultados -->
                <div id="resultados" style="display: none;">
                    <!-- Resumo geral -->
                    <div class="resumo-geral" id="resumoGeral"></div>

                    <!-- Fases -->
                    <div id="fasesContainer" style="margin-top: 16px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ================================================================
    // ESTADO GLOBAL
    // ================================================================
    let dadosResultado = null;
    let datasEntregaCount = 0;
    let leadTimeFornecedor = 15; // default

    // ================================================================
    // INICIALIZACAO
    // ================================================================
    document.addEventListener('DOMContentLoaded', function() {
        carregarLojas();
        carregarFornecedores();
        carregarLinhas();
        // Adicionar 1 data de entrega padrao
        adicionarDataEntrega();
    });

    // ================================================================
    // CARREGAR DADOS DOS FILTROS
    // ================================================================
    async function carregarLojas() {
        try {
            const res = await fetch('/api/lojas');
            const data = await res.json();
            const container = document.getElementById('lojasContainer');
            container.innerHTML = '';
            (data.lojas || []).forEach(l => {
                container.innerHTML += `
                    <label>
                        <input type="checkbox" value="${l.cod_empresa}" checked>
                        ${l.nome_loja}
                    </label>`;
            });
        } catch(e) { console.error('Erro ao carregar lojas:', e); }
    }

    async function carregarFornecedores() {
        try {
            const res = await fetch('/api/fornecedores');
            const data = await res.json();
            const container = document.getElementById('fornecedorContainer');
            container.innerHTML = '';
            (data.fornecedores || []).forEach(f => {
                container.innerHTML += `
                    <label>
                        <input type="checkbox" value="${f.nome_fornecedor}" onchange="onFornecedorChange()">
                        ${f.nome_fornecedor}
                    </label>`;
            });
        } catch(e) { console.error('Erro ao carregar fornecedores:', e); }
    }

    async function onFornecedorChange() {
        const checks = document.querySelectorAll('#fornecedorContainer input[type="checkbox"]:checked');
        const nomes = Array.from(checks).map(c => c.value);
        if (nomes.length === 0) {
            leadTimeFornecedor = 15;
            return;
        }
        try {
            const res = await fetch(`/api/compra_planejada/lead_time?fornecedores=${encodeURIComponent(nomes.join(','))}`);
            const data = await res.json();
            leadTimeFornecedor = data.lead_time_dias || 15;
            atualizarDatasComLeadTime();
        } catch(e) { console.error('Erro ao buscar lead time:', e); }
    }

    function atualizarDatasComLeadTime() {
        const container = document.getElementById('datasEntregaContainer');
        const entries = container.querySelectorAll('.data-entry');
        entries.forEach((entry, i) => {
            const input = entry.querySelector('input[type="date"]');
            if (input) {
                let base = new Date();
                if (i > 0) {
                    const prevInput = entries[i - 1].querySelector('input[type="date"]');
                    if (prevInput && prevInput.value) {
                        base = new Date(prevInput.value + 'T00:00:00');
                    }
                }
                const diasAdd = i === 0 ? leadTimeFornecedor : 30;
                base.setDate(base.getDate() + diasAdd);
                input.value = base.toISOString().split('T')[0];
            }
        });
    }

    async function carregarLinhas() {
        try {
            const res = await fetch('/api/linhas');
            const data = await res.json();
            const sel = document.getElementById('linha1');
            sel.innerHTML = '<option value="TODAS">Todas</option>';
            (data.linhas || []).forEach(l => {
                sel.innerHTML += `<option value="${l}">${l}</option>`;
            });
        } catch(e) { console.error('Erro ao carregar linhas:', e); }
        // Carregar todas as sublinhas inicialmente
        await carregarSublinhas();
    }

    async function carregarSublinhas(categoria) {
        try {
            let url = '/api/sublinhas';
            if (categoria) url += `?categoria=${encodeURIComponent(categoria)}`;
            const res = await fetch(url);
            const data = await res.json();
            const sel = document.getElementById('linha3');
            sel.innerHTML = '<option value="TODAS">Todas</option>';
            (data.sublinhas || []).forEach(s => {
                sel.innerHTML += `<option value="${s.codigo || s.descricao}">${s.descricao || s.codigo}</option>`;
            });
        } catch(e) { console.error('Erro ao carregar sublinhas:', e); }
    }

    // Linha1 -> Linha3 cascata
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('linha1').addEventListener('change', async function() {
            const cat = this.value && this.value !== 'TODAS' ? this.value : null;
            await carregarSublinhas(cat);
        });
    });

    // ================================================================
    // DATAS DE ENTREGA
    // ================================================================
    function adicionarDataEntrega() {
        datasEntregaCount++;
        const container = document.getElementById('datasEntregaContainer');
        const div = document.createElement('div');
        div.className = 'data-entry';
        div.id = `dataEntry_${datasEntregaCount}`;

        const numDatas = container.children.length;
        const isFirst = numDatas === 0;

        // Data padrao: 1o pedido = hoje + lead time do fornecedor
        //             demais = ultima data + 30 dias
        let dataPadrao = new Date();
        if (numDatas > 0) {
            const ultimaInput = container.lastElementChild.querySelector('input[type="date"]');
            if (ultimaInput && ultimaInput.value) {
                dataPadrao = new Date(ultimaInput.value + 'T00:00:00');
            }
            dataPadrao.setDate(dataPadrao.getDate() + 30);
        } else {
            dataPadrao.setDate(dataPadrao.getDate() + leadTimeFornecedor);
        }
        const dataStr = dataPadrao.toISOString().split('T')[0];

        const faseLabel = isFirst ? 'completo' : 'bruta';

        div.innerHTML = `
            <span class="fase-label ${faseLabel}">Pedido ${numDatas + 1}</span>
            <input type="date" value="${dataStr}" onchange="atualizarFaseLabels()">
            ${!isFirst ? `<button class="btn-remove-data" onclick="removerDataEntrega('dataEntry_${datasEntregaCount}')">X</button>` : ''}
        `;
        container.appendChild(div);
        atualizarFaseLabels();
    }

    function removerDataEntrega(id) {
        const el = document.getElementById(id);
        if (el) {
            el.remove();
            atualizarFaseLabels();
        }
    }

    function atualizarFaseLabels() {
        const container = document.getElementById('datasEntregaContainer');
        const entries = container.querySelectorAll('.data-entry');
        entries.forEach((entry, i) => {
            const label = entry.querySelector('.fase-label');
            if (label) {
                const isFirst = i === 0;
                label.className = `fase-label ${isFirst ? 'completo' : 'bruta'}`;
                label.textContent = `Pedido ${i + 1}`;
            }
        });
    }

    // ================================================================
    // CALCULAR COMPRA PLANEJADA
    // ================================================================
    async function calcularCompraPlanejada() {
        // Coletar fornecedores selecionados
        const fornChecks = document.querySelectorAll('#fornecedorContainer input[type="checkbox"]:checked');
        const fornecedores = Array.from(fornChecks).map(c => c.value);

        if (fornecedores.length === 0) {
            alert('Selecione pelo menos um fornecedor.');
            return;
        }

        // Coletar datas de entrega
        const dataInputs = document.querySelectorAll('#datasEntregaContainer input[type="date"]');
        const datas = Array.from(dataInputs).map(i => i.value).filter(v => v);

        if (datas.length === 0) {
            alert('Adicione pelo menos uma data de entrega.');
            return;
        }

        // Coletar lojas
        const lojaChecks = document.querySelectorAll('#lojasContainer input[type="checkbox"]:checked');
        const lojas = Array.from(lojaChecks).map(c => parseInt(c.value));

        const coberturaVal = document.getElementById('coberturaDias').value;

        const payload = {
            fornecedor: fornecedores,
            cod_empresa: lojas.length > 0 ? lojas : 'TODAS',
            destino_tipo: document.getElementById('destinoTipo').value,
            datas_entrega: datas,
            linha1: document.getElementById('linha1').value,
            linha3: document.getElementById('linha3').value,
            cobertura_dias: coberturaVal ? parseInt(coberturaVal) : null,
        };

        // UI: mostrar progresso
        const btn = document.getElementById('btnCalcular');
        btn.disabled = true;
        btn.textContent = 'Calculando...';
        document.getElementById('instrucoes').style.display = 'none';
        document.getElementById('errorCard').style.display = 'none';
        document.getElementById('resultados').style.display = 'none';
        document.getElementById('progressCard').style.display = 'block';

        // Simular progresso
        let progresso = 0;
        const progressInterval = setInterval(() => {
            progresso = Math.min(progresso + 5, 90);
            document.getElementById('progressFill').style.width = progresso + '%';
            document.getElementById('progressText').textContent = `Calculando... ${progresso}%`;
        }, 300);

        try {
            const res = await fetch('/api/compra_planejada/calcular', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            clearInterval(progressInterval);
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = 'Concluido!';

            setTimeout(() => {
                document.getElementById('progressCard').style.display = 'none';

                if (data.success) {
                    dadosResultado = data;
                    exibirResultados(data);
                } else {
                    document.getElementById('errorCard').style.display = 'block';
                    document.getElementById('errorMessage').textContent = data.erro || 'Erro desconhecido';
                }
            }, 500);

        } catch(err) {
            clearInterval(progressInterval);
            document.getElementById('progressCard').style.display = 'none';
            document.getElementById('errorCard').style.display = 'block';
            document.getElementById('errorMessage').textContent = 'Erro de comunicacao: ' + err.message;
        }

        btn.disabled = false;
        btn.textContent = 'Calcular Compra Planejada';
    }

    // ================================================================
    // EXIBIR RESULTADOS
    // ================================================================
    function exibirResultados(data) {
        document.getElementById('resultados').style.display = 'block';

        const fases = data.fases || [];
        const consolidado = data.consolidado || {};
        const fornecedores = data.fornecedores || [];

        // Resumo geral
        const resumoEl = document.getElementById('resumoGeral');
        resumoEl.innerHTML = `
            <div class="titulo">COMPRA PLANEJADA</div>
            <div class="fornecedor">${fornecedores.join(', ')}</div>
            <div class="resumo-metricas">
                <div class="metrica">
                    <div class="valor">${consolidado.num_fases || 0}</div>
                    <div class="label">PEDIDOS</div>
                </div>
                <div class="metrica">
                    <div class="valor">${consolidado.total_itens_unicos || 0}</div>
                    <div class="label">ITENS</div>
                </div>
                <div class="metrica">
                    <div class="valor">${formatarNumero(consolidado.total_quantidade || 0)}</div>
                    <div class="label">QTD TOTAL</div>
                </div>
                <div class="metrica">
                    <div class="valor">R$ ${formatarValor(consolidado.total_valor || 0)}</div>
                    <div class="label">VALOR TOTAL</div>
                </div>
            </div>
        `;

        // Fases
        const fasesEl = document.getElementById('fasesContainer');
        fasesEl.innerHTML = '';

        fases.forEach(fase => {
            try {
                const isCompleto = fase.tipo_calculo === 'completo';
                const tipoClass = isCompleto ? 'completo' : 'bruta';

                const faseCard = document.createElement('div');
                faseCard.className = 'fase-card';
                faseCard.style.marginBottom = '16px';

                const tabelaHtml = gerarTabela(fase);

                faseCard.innerHTML = `
                    <div class="fase-header ${tipoClass}">
                        <div>
                            <div class="fase-titulo">Pedido ${fase.fase} - Entrega: ${formatarData(fase.data_entrega)}</div>
                            <div class="fase-info">${fase.periodo_dias} dias | ${fase.total_itens || 0} itens</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="fase-valor">R$ ${formatarValor(fase.total_valor)}</div>
                            <div class="fase-info">${formatarNumero(fase.total_quantidade)} un</div>
                        </div>
                    </div>
                    <div class="fase-body">
                        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px;">
                            <button class="btn-sm btn-toggle" onclick="toggleTabela(${fase.fase})">
                                Mostrar/Ocultar Itens
                            </button>
                        </div>
                        <div class="tabela-container" id="tabela_fase_${fase.fase}" style="display: none;">
                            ${tabelaHtml}
                        </div>
                    </div>
                `;
                fasesEl.appendChild(faseCard);
            } catch(e) {
                console.error('Erro ao renderizar fase', fase.fase, e);
            }
        });

        // Botao exportar
        const exportDiv = document.createElement('div');
        exportDiv.style.cssText = 'text-align: center; margin-top: 16px;';
        exportDiv.innerHTML = `
            <button class="btn-sm btn-exportar" style="padding: 12px 40px; font-size: 1em;"
                    onclick="exportarExcel()">
                Exportar Excel (Todas as Fases)
            </button>
        `;
        fasesEl.appendChild(exportDiv);
    }

    function gerarTabela(fase) {
        try {
            const isCompleto = fase.tipo_calculo === 'completo';
            const thClass = isCompleto ? 'completo' : 'bruta';
            const itens = (fase.itens || []).filter(i => (i.quantidade_pedido || 0) > 0)
                .sort((a, b) => (b.valor_total || 0) - (a.valor_total || 0));

            if (itens.length === 0) {
                return '<p style="text-align:center;color:#9ca3af;padding:20px;">Nenhum item com pedido nesta fase.</p>';
            }

            let headers, rows;
            if (isCompleto) {
                headers = '<tr>' +
                    `<th class="${thClass}">Codigo</th>` +
                    `<th class="${thClass}">Descricao</th>` +
                    `<th class="${thClass}">ABC</th>` +
                    `<th class="${thClass}">Dem/dia</th>` +
                    `<th class="${thClass}">Dem Periodo</th>` +
                    `<th class="${thClass}">Estoque</th>` +
                    `<th class="${thClass}">ES</th>` +
                    `<th class="${thClass}">Pedido</th>` +
                    `<th class="${thClass}">Caixas</th>` +
                    `<th class="${thClass}">CUE</th>` +
                    `<th class="${thClass}">Valor (R$)</th>` +
                    '</tr>';
                rows = itens.map(i => `<tr>
                    <td>${i.codigo}</td>
                    <td class="col-desc" title="${i.descricao || ''}">${i.descricao || ''}</td>
                    <td style="text-align:center">${i.curva_abc || ''}</td>
                    <td class="col-num">${(i.demanda_diaria || 0).toFixed(1)}</td>
                    <td class="col-num">${formatarNumero(i.demanda_periodo)}</td>
                    <td class="col-num">${formatarNumero(i.estoque_atual)}</td>
                    <td class="col-num">${formatarNumero(i.estoque_seguranca)}</td>
                    <td class="col-num" style="font-weight:600">${formatarNumero(i.quantidade_pedido)}</td>
                    <td class="col-num">${i.numero_caixas || 0}</td>
                    <td class="col-num">${(i.cue || 0).toFixed(2)}</td>
                    <td class="col-num" style="font-weight:600">${formatarValor(i.valor_total)}</td>
                </tr>`).join('');
            } else {
                headers = '<tr>' +
                    `<th class="${thClass}">Codigo</th>` +
                    `<th class="${thClass}">Descricao</th>` +
                    `<th class="${thClass}">Dem/dia</th>` +
                    `<th class="${thClass}">Dias</th>` +
                    `<th class="${thClass}">Dem Periodo</th>` +
                    `<th class="${thClass}">Est. Projetado</th>` +
                    `<th class="${thClass}">Pedido</th>` +
                    `<th class="${thClass}">Caixas</th>` +
                    `<th class="${thClass}">CUE</th>` +
                    `<th class="${thClass}">Valor (R$)</th>` +
                    '</tr>';
                rows = itens.map(i => `<tr>
                    <td>${i.codigo}</td>
                    <td class="col-desc" title="${i.descricao || ''}">${i.descricao || ''}</td>
                    <td class="col-num">${(i.demanda_diaria || 0).toFixed(1)}</td>
                    <td class="col-num">${fase.periodo_dias}</td>
                    <td class="col-num">${formatarNumero(i.demanda_periodo)}</td>
                    <td class="col-num">${formatarNumero(i.estoque_atual)}</td>
                    <td class="col-num" style="font-weight:600">${formatarNumero(i.quantidade_pedido)}</td>
                    <td class="col-num">${i.numero_caixas || 0}</td>
                    <td class="col-num">${(i.cue || 0).toFixed(2)}</td>
                    <td class="col-num" style="font-weight:600">${formatarValor(i.valor_total)}</td>
                </tr>`).join('');
            }

            return `<table class="tabela-itens"><thead>${headers}</thead><tbody>${rows}</tbody></table>`;
        } catch(e) {
            console.error('Erro ao gerar tabela fase', fase.fase, e);
            return `<p style="color:red;padding:10px;">Erro ao renderizar tabela: ${e.message}</p>`;
        }
    }

    function toggleTabela(fase) {
        const el = document.getElementById(`tabela_fase_${fase}`);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    // ================================================================
    // EXPORTAR EXCEL
    // ================================================================
    async function exportarExcel() {
        if (!dadosResultado) {
            alert('Nenhum resultado para exportar.');
            return;
        }

        try {
            const res = await fetch('/api/compra_planejada/exportar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dadosResultado)
            });

            if (!res.ok) {
                const err = await res.json();
                alert('Erro ao exportar: ' + (err.erro || 'Erro desconhecido'));
                return;
            }

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compra_planejada_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

        } catch(err) {
            alert('Erro ao exportar: ' + err.message);
        }
    }

    // ================================================================
    // UTILITARIOS
    // ================================================================
    function marcarTodos(containerId) {
        document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => cb.checked = true);
    }
    function desmarcarTodos(containerId) {
        document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => cb.checked = false);
    }

    function formatarValor(v) {
        return (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function formatarNumero(v) {
        return Math.round(v || 0).toLocaleString('pt-BR');
    }
    function formatarData(d) {
        if (!d) return '';
        const parts = d.split('-');
        if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
        return d;
    }
    </script>
</body>
</html>
