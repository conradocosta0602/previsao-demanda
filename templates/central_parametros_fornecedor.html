<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Parametros de Fornecedor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }

        body {
            background: #f8f9fa;
        }

        .navbar-custom {
            background: linear-gradient(135deg, #4a5568 0%, #5a6778 100%);
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
            border: none;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            background: white;
        }

        .card-body { padding: 20px; }

        .nav-tabs {
            border-bottom: 2px solid #e5e7eb;
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 0 20px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6b7280;
            font-weight: 500;
            padding: 14px 20px;
            margin-bottom: -2px;
        }

        .nav-tabs .nav-link:hover {
            border: none;
            color: #6366f1;
        }

        .nav-tabs .nav-link.active {
            color: #6366f1;
            border: none;
            border-bottom: 2px solid #6366f1;
            background: transparent;
        }

        .card-fornecedor {
            border-left: 4px solid #6366f1;
        }

        .fornecedor-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .search-box {
            position: relative;
        }
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        .search-box input {
            padding-left: 38px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .form-select, .form-control {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9em;
            padding: 8px 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        /* Tabela de parametros por loja */
        .params-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .params-table th {
            background: #f9fafb;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 0.75em;
            text-transform: uppercase;
        }

        .params-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .params-table tr:hover {
            background: #f9fafb;
        }

        .params-table .row-label {
            text-align: left;
            font-weight: 500;
            color: #374151;
            padding-left: 12px;
            background: #fafafa;
            width: 120px;
        }

        .param-input {
            width: 70px;
            padding: 4px 6px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .param-input:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99,102,241,0.2);
        }

        .param-input.saving {
            background: #fef3c7;
        }

        .param-input.saved {
            background: #d1e7dd;
            border-color: #10b981;
        }

        .param-input.error {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .param-input:disabled {
            background: #f9fafb;
            color: #9ca3af;
        }

        .param-input-money {
            width: 85px;
        }

        /* Linha de cobertura calculada */
        .cobertura-row td {
            background: #f0f9ff;
            font-weight: 500;
            color: #0369a1;
            font-size: 0.85em;
        }

        .cobertura-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .cobertura-a { background: #d1fae5; color: #065f46; }
        .cobertura-b { background: #fef3c7; color: #92400e; }
        .cobertura-c { background: #dbeafe; color: #1e40af; }

        /* Resumo */
        .resumo-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
        }

        .resumo-item {
            display: inline-flex;
            align-items: center;
            margin-right: 24px;
            font-size: 0.85em;
        }

        .resumo-item strong {
            color: #0369a1;
            margin-left: 4px;
        }

        /* Status de nao cadastrado */
        .not-configured {
            color: #9ca3af;
            font-style: italic;
        }

        .loja-header {
            font-size: 0.7em;
            line-height: 1.2;
        }

        .loja-header .loja-num {
            font-weight: 700;
            font-size: 1.1em;
        }

        .loja-header .loja-nome {
            color: #6b7280;
            font-weight: 400;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        /* Produtos */
        .produtos-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .table-produtos th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 10;
            font-size: 0.8em;
        }

        .table-produtos td {
            font-size: 0.85em;
        }

        .sit-compra-badge {
            font-size: 0.72em;
            padding: 0.25em 0.6em;
            border-radius: 4px;
            font-weight: 500;
        }
        .sit-compra-FL { background-color: #6b7280; color: white; }
        .sit-compra-NC { background-color: #ef4444; color: white; }
        .sit-compra-EN { background-color: #f59e0b; color: #1f2937; }
        .sit-compra-CO { background-color: #06b6d4; color: #1f2937; }
        .sit-compra-FF { background-color: #f97316; color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-graph-up-arrow"></i> Previsao de Demanda
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/menu"><i class="bi bi-grid-3x3-gap"></i> Menu</a>
                <a class="nav-link" href="/pedido_fornecedor_integrado"><i class="bi bi-cart"></i> Pedido Fornecedor</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2><i class="bi bi-gear-wide-connected"></i> Central de Parametros de Fornecedor</h2>
        <p class="text-muted">Consulte e edite Lead Time, Ciclo de Pedido e Pedido Minimo por filial</p>

        <!-- Abas -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta" type="button">
                    <i class="bi bi-search"></i> Consulta
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="importacao-tab" data-bs-toggle="tab" data-bs-target="#importacao" type="button">
                    <i class="bi bi-upload"></i> Importacao
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- ABA CONSULTA -->
            <div class="tab-pane fade show active" id="consulta" role="tabpanel">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-body">
                        <!-- Filtros de busca -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Codigo do Produto</label>
                                <div class="search-box">
                                    <i class="bi bi-upc-scan"></i>
                                    <input type="text" class="form-control" id="filtro-codigo" placeholder="Ex: 123456">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CNPJ Fornecedor</label>
                                <div class="search-box">
                                    <i class="bi bi-building"></i>
                                    <input type="text" class="form-control" id="filtro-cnpj" placeholder="Ex: 12345678000199">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Nome Fornecedor</label>
                                <div class="search-box">
                                    <i class="bi bi-person"></i>
                                    <input type="text" class="form-control" id="filtro-nome" placeholder="Ex: HIDRO FILTROS">
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="buscarFornecedor()">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </div>

                        <!-- Resultados -->
                        <div id="resultados-container">
                            <div class="no-results">
                                <i class="bi bi-search" style="font-size: 3rem; color: #d1d5db;"></i>
                                <p class="mt-3">Use os filtros acima para buscar um fornecedor</p>
                                <small class="text-muted">Voce pode buscar por codigo de produto, CNPJ ou nome do fornecedor</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA IMPORTACAO -->
            <div class="tab-pane fade" id="importacao" role="tabpanel">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Para importar lead times em massa, use o arquivo Excel no formato:
                            <strong>CNPJ, COD_EMPRESA, LEAD_TIME_DIAS, CICLO_PEDIDO_DIAS, PEDIDO_MINIMO</strong>
                        </div>
                        <p class="text-muted">Funcionalidade de importacao em desenvolvimento.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Estado global
        let lojas = [];
        let fornecedorAtual = null;
        let parametrosLojas = [];
        let produtosCarregados = [];
        let alteracoesPendentes = {};

        // Inicializacao
        document.addEventListener('DOMContentLoaded', function() {
            carregarLojas();

            // Eventos de Enter nos filtros
            ['filtro-codigo', 'filtro-cnpj', 'filtro-nome'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') buscarFornecedor();
                });
            });
        });

        async function carregarLojas() {
            try {
                const response = await fetch('/api/lojas');
                lojas = await response.json();
            } catch (error) {
                console.error('Erro ao carregar lojas:', error);
            }
        }

        async function buscarFornecedor() {
            const codigo = document.getElementById('filtro-codigo').value.trim();
            const cnpj = document.getElementById('filtro-cnpj').value.trim();
            const nome = document.getElementById('filtro-nome').value.trim();

            if (!codigo && !cnpj && !nome) {
                alert('Informe pelo menos um filtro de busca');
                return;
            }

            const container = document.getElementById('resultados-container');
            container.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status"></div>
                    <span class="ms-2">Buscando fornecedor...</span>
                </div>
            `;

            try {
                // Primeiro buscar dados basicos do fornecedor
                const params = new URLSearchParams();
                if (codigo) params.append('codigo', codigo);
                if (cnpj) params.append('cnpj', cnpj);
                if (nome) params.append('nome', nome);

                const response = await fetch(`/api/central-parametros/buscar?${params.toString()}`);
                const data = await response.json();

                if (!data.success) {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> ${data.mensagem || 'Fornecedor nao encontrado'}
                        </div>
                    `;
                    return;
                }

                fornecedorAtual = data.fornecedor;
                // Normalizar campos do fornecedor
                fornecedorAtual.cnpj_fornecedor = fornecedorAtual.cnpj || fornecedorAtual.cnpj_fornecedor;
                fornecedorAtual.nome_fornecedor = fornecedorAtual.nome || fornecedorAtual.nome_fornecedor;

                produtosCarregados = data.produtos || [];

                // Usar parametros e lojas ja retornados pela API
                const parametrosExistentes = data.parametros || [];
                const lojasDisponiveis = data.lojas || [];

                // Criar lista completa de parametros por loja (preenchendo lojas sem cadastro)
                parametrosLojas = lojasDisponiveis.map(loja => {
                    const paramExistente = parametrosExistentes.find(p => p.cod_empresa == loja.cod_empresa);
                    return {
                        cod_empresa: loja.cod_empresa,
                        nome_loja: loja.nome_loja,
                        tipo_destino: paramExistente?.tipo_destino || 'LOJA',
                        lead_time_dias: paramExistente?.lead_time_dias || 15,
                        ciclo_pedido_dias: paramExistente?.ciclo_pedido_dias || 7,
                        pedido_minimo_valor: paramExistente?.pedido_minimo_valor || 0,
                        cadastrado: !!paramExistente
                    };
                });

                renderizarResultados();

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Erro ao buscar: ${error.message}
                    </div>
                `;
            }
        }

        function renderizarResultados() {
            const container = document.getElementById('resultados-container');
            alteracoesPendentes = {};

            let html = `
                <!-- Card do Fornecedor -->
                <div class="card card-fornecedor mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h4 class="mb-1">
                                    <i class="bi bi-building"></i> ${fornecedorAtual.nome_fornecedor || 'Fornecedor'}
                                </h4>
                                <p class="text-muted mb-0">CNPJ: ${formatarCNPJ(fornecedorAtual.cnpj_fornecedor)}</p>
                            </div>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="salvarTodosParametros()" id="btn-salvar">
                                    <i class="bi bi-check-circle"></i> Salvar Alteracoes
                                </button>
                            </div>
                        </div>

                        <!-- Tabela de Parametros por Loja -->
                        <h6 class="mb-3"><i class="bi bi-grid-3x3"></i> Parametros por Filial</h6>
                        <div class="table-responsive">
                            <table class="params-table">
                                <thead>
                                    <tr>
                                        <th style="width: 120px;"></th>
                                        ${parametrosLojas.map(p => `
                                            <th>
                                                <div class="loja-header">
                                                    <div class="loja-num">Lj ${p.cod_empresa}</div>
                                                    <div class="loja-nome">${abreviarNome(p.nome_loja)}</div>
                                                </div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Lead Time -->
                                    <tr>
                                        <td class="row-label"><i class="bi bi-clock"></i> Lead Time</td>
                                        ${parametrosLojas.map(p => `
                                            <td>
                                                <input type="number" class="param-input"
                                                    id="lt-${p.cod_empresa}"
                                                    value="${p.lead_time_dias || ''}"
                                                    placeholder="-"
                                                    min="1" max="365"
                                                    onchange="marcarAlteracao(${p.cod_empresa}, 'lead_time_dias', this.value)">
                                                <small class="text-muted">d</small>
                                            </td>
                                        `).join('')}
                                    </tr>
                                    <!-- Ciclo Pedido -->
                                    <tr>
                                        <td class="row-label"><i class="bi bi-arrow-repeat"></i> Ciclo Pedido</td>
                                        ${parametrosLojas.map(p => `
                                            <td>
                                                <input type="number" class="param-input"
                                                    id="ciclo-${p.cod_empresa}"
                                                    value="${p.ciclo_pedido_dias || 7}"
                                                    min="1" max="90"
                                                    onchange="marcarAlteracao(${p.cod_empresa}, 'ciclo_pedido_dias', this.value)">
                                                <small class="text-muted">d</small>
                                            </td>
                                        `).join('')}
                                    </tr>
                                    <!-- Pedido Minimo -->
                                    <tr>
                                        <td class="row-label"><i class="bi bi-currency-dollar"></i> Ped. Minimo</td>
                                        ${parametrosLojas.map(p => `
                                            <td>
                                                <input type="number" class="param-input param-input-money"
                                                    id="pedmin-${p.cod_empresa}"
                                                    value="${p.pedido_minimo_valor || 0}"
                                                    min="0" step="100"
                                                    onchange="marcarAlteracao(${p.cod_empresa}, 'pedido_minimo_valor', this.value)">
                                            </td>
                                        `).join('')}
                                    </tr>
                                    <!-- Cobertura Calculada (somente leitura) -->
                                    <tr class="cobertura-row">
                                        <td class="row-label">Cobertura A</td>
                                        ${parametrosLojas.map(p => {
                                            const lt = p.lead_time_dias || 30;
                                            const ciclo = p.ciclo_pedido_dias || 7;
                                            return `<td><span class="cobertura-badge cobertura-a">${lt + ciclo + 2}d</span></td>`;
                                        }).join('')}
                                    </tr>
                                    <tr class="cobertura-row">
                                        <td class="row-label">Cobertura B</td>
                                        ${parametrosLojas.map(p => {
                                            const lt = p.lead_time_dias || 30;
                                            const ciclo = p.ciclo_pedido_dias || 7;
                                            return `<td><span class="cobertura-badge cobertura-b">${lt + ciclo + 4}d</span></td>`;
                                        }).join('')}
                                    </tr>
                                    <tr class="cobertura-row">
                                        <td class="row-label">Cobertura C</td>
                                        ${parametrosLojas.map(p => {
                                            const lt = p.lead_time_dias || 30;
                                            const ciclo = p.ciclo_pedido_dias || 7;
                                            return `<td><span class="cobertura-badge cobertura-c">${lt + ciclo + 6}d</span></td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Resumo -->
                        ${fornecedorAtual.resumo ? `
                            <div class="resumo-box">
                                <span class="resumo-item">
                                    <i class="bi bi-speedometer2"></i> Lead Time Min: <strong>${fornecedorAtual.resumo.lead_time_min || '-'}d</strong>
                                </span>
                                <span class="resumo-item">
                                    <i class="bi bi-bar-chart"></i> Media: <strong>${fornecedorAtual.resumo.lead_time_medio || '-'}d</strong>
                                </span>
                                <span class="resumo-item">
                                    <i class="bi bi-speedometer"></i> Max: <strong>${fornecedorAtual.resumo.lead_time_max || '-'}d</strong>
                                </span>
                                <span class="resumo-item">
                                    <i class="bi bi-shop"></i> Lojas cadastradas: <strong>${fornecedorAtual.resumo.lojas_cadastradas || 0}/${fornecedorAtual.resumo.lojas_total || 0}</strong>
                                </span>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Lista de Produtos -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-box-seam"></i> Produtos do Fornecedor</span>
                        <span class="badge bg-primary">${produtosCarregados.length} itens</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="produtos-container">
                            <table class="table table-sm table-hover table-produtos mb-0">
                                <thead>
                                    <tr>
                                        <th>Codigo</th>
                                        <th>Descricao</th>
                                        <th>Linha</th>
                                        <th class="text-center">Curva ABC</th>
                                        <th class="text-center">Sit. Compra</th>
                                        <th class="text-center">Padrao Compra</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${produtosCarregados.length === 0 ? `
                                        <tr><td colspan="6" class="text-center text-muted py-4">Nenhum produto encontrado</td></tr>
                                    ` : produtosCarregados.slice(0, 100).map(p => `
                                        <tr>
                                            <td><code>${p.cod_produto}</code></td>
                                            <td>${p.descricao || ''}</td>
                                            <td><small class="text-muted">${p.descricao_linha || p.categoria || '-'}</small></td>
                                            <td class="text-center">
                                                ${p.curva_abc ? `<span class="badge bg-${p.curva_abc === 'A' ? 'success' : p.curva_abc === 'B' ? 'warning' : 'primary'}">${p.curva_abc}</span>` : '-'}
                                            </td>
                                            <td class="text-center">
                                                ${p.sit_compra ? `<span class="badge sit-compra-badge sit-compra-${p.sit_compra}">${p.sit_compra}</span>` : '-'}
                                            </td>
                                            <td class="text-center">
                                                ${p.padrao_compra ? `<span class="badge bg-info" title="Loja destino do pedido">${p.padrao_compra}</span>` : '<span class="text-muted">-</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${produtosCarregados.length > 100 ? `
                                        <tr><td colspan="6" class="text-center text-muted py-2">... e mais ${produtosCarregados.length - 100} produtos</td></tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function marcarAlteracao(codEmpresa, campo, valor) {
            if (!alteracoesPendentes[codEmpresa]) {
                alteracoesPendentes[codEmpresa] = {};
            }
            alteracoesPendentes[codEmpresa][campo] = valor ? parseFloat(valor) : null;

            // Feedback visual
            const input = document.getElementById(`${campo === 'lead_time_dias' ? 'lt' : campo === 'ciclo_pedido_dias' ? 'ciclo' : 'pedmin'}-${codEmpresa}`);
            if (input) {
                input.classList.add('saving');
                setTimeout(() => input.classList.remove('saving'), 300);
            }

            // Atualizar coberturas calculadas
            atualizarCoberturas(codEmpresa);
        }

        function atualizarCoberturas(codEmpresa) {
            const ltInput = document.getElementById(`lt-${codEmpresa}`);
            const cicloInput = document.getElementById(`ciclo-${codEmpresa}`);

            const lt = parseInt(ltInput?.value) || 30;
            const ciclo = parseInt(cicloInput?.value) || 7;

            // Atualizar badges de cobertura na tabela
            // (simplificado - seria necessario IDs nos badges para atualizar dinamicamente)
        }

        async function salvarTodosParametros() {
            const btn = document.getElementById('btn-salvar');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';

            try {
                // Montar lista de parametros para salvar
                const parametros = [];

                parametrosLojas.forEach(p => {
                    const ltInput = document.getElementById(`lt-${p.cod_empresa}`);
                    const cicloInput = document.getElementById(`ciclo-${p.cod_empresa}`);
                    const pedminInput = document.getElementById(`pedmin-${p.cod_empresa}`);

                    const lt = ltInput?.value ? parseInt(ltInput.value) : null;
                    const ciclo = cicloInput?.value ? parseInt(cicloInput.value) : 7;
                    const pedmin = pedminInput?.value ? parseFloat(pedminInput.value) : 0;

                    if (lt !== null) {
                        parametros.push({
                            cod_empresa: p.cod_empresa,
                            lead_time_dias: lt,
                            ciclo_pedido_dias: ciclo,
                            pedido_minimo_valor: pedmin
                        });
                    }
                });

                if (parametros.length === 0) {
                    alert('Nenhum parametro para salvar. Preencha ao menos um Lead Time.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Alteracoes';
                    return;
                }

                const response = await fetch('/api/central-parametros/salvar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cnpj_fornecedor: fornecedorAtual.cnpj_fornecedor,
                        nome_fornecedor: fornecedorAtual.nome_fornecedor,
                        parametros: parametros
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Feedback visual de sucesso
                    document.querySelectorAll('.param-input').forEach(input => {
                        if (input.value) {
                            input.classList.add('saved');
                            setTimeout(() => input.classList.remove('saved'), 2000);
                        }
                    });

                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvo!';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Alteracoes';
                        btn.disabled = false;
                    }, 2000);

                    // Atualizar dados
                    alteracoesPendentes = {};
                } else {
                    alert('Erro ao salvar: ' + result.mensagem);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Alteracoes';
                }

            } catch (error) {
                alert('Erro ao salvar: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Alteracoes';
            }
        }

        function formatarCNPJ(cnpj) {
            if (!cnpj) return '';
            const c = cnpj.replace(/\D/g, '').padStart(14, '0');
            return `${c.slice(0,2)}.${c.slice(2,5)}.${c.slice(5,8)}/${c.slice(8,12)}-${c.slice(12,14)}`;
        }

        function abreviarNome(nome) {
            if (!nome) return '';
            if (nome.length <= 8) return nome;
            return nome.substring(0, 7) + '...';
        }
    </script>
</body>
</html>
